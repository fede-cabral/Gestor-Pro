<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FORJAX ANGEL PROTOCOL</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=JetBrains+Mono:wght@400;700;800&display=swap');

        body {
            background-color: #05030a; /* Fondo m√°s oscuro, toque p√∫rpura */
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
            background-image: radial-gradient(circle at 50% -20%, #2e1065 0%, #05030a 70%);
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* PANELES VIDRIO C√ìSMICO */
        .panel {
            background: linear-gradient(180deg, rgba(30, 20, 50, 0.4) 0%, rgba(10, 5, 20, 0.6) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            box-shadow: 0 4px 30px rgba(0,0,0,0.5);
        }

        .up { color: #10b981; text-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }
        .down { color: #f43f5e; text-shadow: 0 0 10px rgba(244, 63, 94, 0.4); }

        /* BOTONES */
        .footer-btn {
            background: linear-gradient(180deg, #1e1b4b 0%, #0f172a 100%);
            border: 1px solid #4c1d95;
            color: #a78bfa;
            border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 800;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .footer-btn:active { transform: scale(0.95); color: #fff; border-color: #c084fc; box-shadow: 0 0 15px rgba(192, 132, 252, 0.4); }
        
        .btn-trade { background: linear-gradient(180deg, #6d28d9 0%, #4c1d95 100%); border-color: #8b5cf6; color: #fff; }
        .btn-trade:active { transform: scale(0.95); box-shadow: 0 0 25px rgba(139, 92, 246, 0.6); }

        .btn-panic { background: #4c0519; border-color: #be123c; color: #fda4af; }
        .btn-panic.active { background: #e11d48; color: white; animation: pulse-red 1s infinite; }

        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(225, 29, 72, 0); } 100% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0); } }

        /* TRADE MODAL */
        #tradeModal {
            position: fixed; bottom: -100%; left: 0; width: 100%;
            background: #0b0714; border-top: 1px solid #4c1d95;
            z-index: 100; transition: bottom 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            padding: 24px; border-radius: 24px 24px 0 0;
            box-shadow: 0 -20px 60px rgba(0,0,0,0.9);
        }
        #tradeModal.open { bottom: 0; }

        /* LEVERAGE BUTTONS */
        .lev-btn { background: #1e1b4b; border: 1px solid #4c1d95; color: #a78bfa; border-radius: 6px; padding: 4px; font-size: 10px; font-weight: bold; transition: all 0.2s; }
        .lev-btn.active { background: #7c3aed; color: #fff; border-color: #a78bfa; box-shadow: 0 0 10px rgba(124, 58, 237, 0.5); }

        /* TOAST NOTIFICATIONS */
        #toastContainer { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 999; display: flex; flex-direction: column; gap: 8px; width: 90%; pointer-events: none; }
        .toast {
            background: rgba(15, 10, 30, 0.95); border: 1px solid #4c1d95; backdrop-filter: blur(10px);
            padding: 12px 16px; border-radius: 12px; display: flex; align-items: center; gap: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6); animation: slideDown 0.3s ease forwards;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }

        /* SENTIMENT BAR */
        .sentiment-track { width: 100%; height: 4px; background: #1e1b4b; border-radius: 2px; overflow: hidden; position: relative; }
        .sentiment-fill { height: 100%; background: linear-gradient(90deg, #f43f5e, #a78bfa, #10b981); position: absolute; left: 0; transition: width 0.3s; }
        .sentiment-marker { position: absolute; top: -2px; width: 2px; height: 8px; background: #fff; box-shadow: 0 0 5px #fff; transition: left 0.3s; }

        /* PRIVACY LAYER */
        #privacyLayer { position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.95); backdrop-filter: blur(25px); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #privacyLayer.active { opacity: 1; pointer-events: auto; }
        .scan-line { width: 100%; height: 2px; background: #c084fc; position: absolute; top: 0; left: 0; animation: scan 2s linear infinite; opacity: 0.5; box-shadow: 0 0 10px #c084fc; }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
    </style>
</head>
<body class="p-2 pb-safe">

    <div id="toastContainer"></div>

    <div id="privacyLayer">
        <div class="relative overflow-hidden text-center p-8 bg-[#05030a] border border-purple-900/50 rounded-3xl w-72 shadow-[0_0_50px_rgba(88,28,135,0.3)]">
            <div class="scan-line"></div>
            <i data-lucide="fingerprint" class="w-16 h-16 text-purple-500 mx-auto mb-4 animate-pulse"></i>
            <h2 class="text-2xl font-black text-white mb-2 tracking-widest">ANGEL OS</h2>
            <p class="text-xs text-purple-400 mb-8 mono">BIOMETRIC LOCK ACTIVE</p>
            <button onclick="togglePanic()" class="w-full bg-purple-600 hover:bg-purple-500 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 shadow-[0_0_20px_rgba(147,51,234,0.4)]">
                AUTHORIZE OVERRIDE
            </button>
        </div>
    </div>

    <header class="flex justify-between items-center h-12 mb-2 px-1">
        <div class="flex items-center gap-2">
            <div class="bg-purple-900/30 p-2 rounded-lg text-purple-400 border border-purple-500/30">
                <i data-lucide="activity" class="w-4 h-4"></i>
            </div>
            <div>
                <h1 class="text-xs font-black text-slate-100 tracking-wider">FORJAX <span class="text-purple-400">ANGEL</span></h1>
                <div class="flex items-center gap-1.5">
                    <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse shadow-[0_0_8px_#10b981]"></div>
                    <span class="text-[9px] text-emerald-500 font-mono font-bold tracking-widest">NEURAL LINK ACTIVE</span>
                </div>
            </div>
        </div>
        <div class="text-right">
            <p id="clock" class="text-sm font-black text-white mono tracking-tighter">00:00:00</p>
        </div>
    </header>

    <div class="grid grid-cols-2 gap-2 mb-2 h-24">
        <div class="grid grid-rows-2 gap-2">
            <div class="panel p-2 flex justify-between items-center">
                <div class="flex flex-col">
                    <span class="text-[9px] text-purple-300/70 font-bold tracking-widest">USD BLUE</span>
                    <span id="dolarVal" class="text-xs font-bold text-white mono mt-0.5">...</span>
                </div>
                <i data-lucide="dollar-sign" class="w-4 h-4 text-purple-500 opacity-50"></i>
            </div>
            <div class="panel p-2 flex justify-between items-center border-purple-500/30 bg-purple-900/10">
                <div class="flex flex-col">
                    <span class="text-[9px] text-purple-400 font-bold tracking-widest">LIQUIDEZ REAL</span>
                    <span id="netVal" class="text-xs font-bold text-white mono mt-0.5">...</span>
                </div>
                <i data-lucide="wallet" class="w-4 h-4 text-purple-400 opacity-50"></i>
            </div>
        </div>
        <div class="grid grid-rows-2 gap-2">
            <div class="panel p-2 flex justify-between items-center">
                <div class="flex flex-col">
                    <span class="text-[9px] text-purple-300/70 font-bold tracking-widest">BTC/USD</span>
                    <span id="btcVal" class="text-xs font-bold text-white mono mt-0.5">...</span>
                </div>
                <span id="btcPct" class="text-[10px] mono font-bold bg-black/40 px-1 py-0.5 rounded border border-white/5">...</span>
            </div>
            <div class="panel p-2 flex justify-between items-center">
                <div class="flex flex-col">
                    <span class="text-[9px] text-purple-300/70 font-bold tracking-widest">ETH/USD</span>
                    <span id="ethVal" class="text-xs font-bold text-white mono mt-0.5">...</span>
                </div>
                <span id="ethPct" class="text-[10px] mono font-bold bg-black/40 px-1 py-0.5 rounded border border-white/5">...</span>
            </div>
        </div>
    </div>

    <div class="panel flex-1 relative mb-2 flex flex-col overflow-hidden">
        <div class="absolute top-2 left-2 z-10 flex gap-2">
            <span class="text-[10px] font-black text-white bg-[#05030a]/80 px-2 py-1 rounded border border-purple-900 tracking-wider backdrop-blur-sm">
                BTC/USDT <span class="text-purple-400 ml-1">‚óè SMA 10</span>
            </span>
        </div>
        <div id="chartContainer" class="flex-1 w-full min-h-0"></div>
        
        <div class="h-8 border-t border-purple-900/30 px-3 flex flex-col justify-center bg-black/20">
            <div class="flex justify-between items-center mb-1">
                <span class="text-[8px] text-purple-400 font-bold tracking-widest">AI MARKET SENTIMENT</span>
                <span id="sentimentText" class="text-[8px] text-white mono font-bold">CALCULATING...</span>
            </div>
            <div class="sentiment-track">
                <div class="sentiment-fill" style="width: 100%;"></div>
                <div id="sentimentMarker" class="sentiment-marker" style="left: 50%;"></div>
            </div>
        </div>
    </div>

    <div class="panel p-3 mb-2 h-20 flex justify-between items-center relative overflow-hidden">
        <div id="liqWarning" class="absolute inset-0 bg-rose-600/20 opacity-0 transition-opacity duration-300 pointer-events-none"></div>
        
        <div class="flex gap-4 z-10">
            <div>
                <p class="text-[9px] text-purple-300 font-bold tracking-wider mb-1">PAPER BALANCE</p>
                <p id="paperUsd" class="text-lg font-black text-white mono">$0.00</p>
            </div>
            <div class="w-px bg-purple-900/50"></div>
            <div>
                <p class="text-[9px] text-purple-300 font-bold tracking-wider mb-1">BTC EXPOSURE</p>
                <div class="flex items-baseline gap-1">
                    <p id="paperBtc" class="text-lg font-black text-purple-400 mono">0.0000</p>
                    <span id="activeLev" class="text-[8px] text-emerald-400 border border-emerald-500/30 px-1 rounded hidden">x10</span>
                </div>
            </div>
        </div>
        <div class="text-right z-10">
            <p class="text-[9px] text-purple-300 font-bold tracking-wider mb-1">MARGIN P&L</p>
            <p id="paperPnl" class="text-sm font-black mono text-slate-500">+$0.00</p>
        </div>
    </div>

    <div class="grid grid-cols-4 gap-2 h-14">
        <button onclick="location.reload()" class="footer-btn">
            <i data-lucide="refresh-cw" class="w-5 h-5 mb-1"></i>SYNC
        </button>
        <button id="btnPanic" onclick="togglePanic()" class="footer-btn btn-panic">
            <i data-lucide="shield-alert" class="w-5 h-5 mb-1"></i>LOCK
        </button>
        <button onclick="openTrade()" class="footer-btn btn-trade border-none shadow-[0_0_15px_rgba(109,40,217,0.3)]">
            <i data-lucide="zap" class="w-5 h-5 mb-1"></i>TRADE
        </button>
        <button onclick="window.location.href='index.html'" class="footer-btn text-rose-400 border-rose-900/30">
            <i data-lucide="log-out" class="w-5 h-5 mb-1"></i>EXIT
        </button>
    </div>

    <div id="tradeModal">
        <div class="flex justify-between items-center mb-4 border-b border-purple-900/50 pb-4">
            <div>
                <h3 class="text-xl font-black text-white tracking-widest flex items-center gap-2">
                    <i data-lucide="crosshair" class="w-5 h-5 text-purple-500"></i> MARGIN TRADE
                </h3>
            </div>
            <button onclick="closeTrade()" class="bg-purple-900/30 hover:bg-purple-800 p-2 rounded-full transition-colors border border-purple-500/30"><i data-lucide="x" class="w-5 h-5 text-purple-300"></i></button>
        </div>
        
        <div class="mb-4 bg-[#05030a] p-4 rounded-xl border border-purple-900/50">
            <div class="flex justify-between text-xs mb-2 mono">
                <span class="text-purple-400 font-bold">FREE MARGIN:</span>
                <span id="modalAvail" class="font-bold text-white">$0.00</span>
            </div>
            
            <div class="relative mb-3">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-purple-500 font-black">$</span>
                <input type="number" id="tradeAmount" value="1000" class="w-full bg-[#0b0714] p-3 pl-8 rounded-xl text-white font-black text-lg border border-purple-800 outline-none focus:border-purple-400 mono transition-colors">
            </div>
            
            <div class="mt-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[10px] text-purple-400 font-bold tracking-widest">LEVERAGE (MULTIPLIER)</span>
                    <span class="text-[9px] text-rose-400 font-bold blink">HIGH RISK</span>
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="setLev(1)" id="btnLev1" class="lev-btn active">1x</button>
                    <button onclick="setLev(10)" id="btnLev10" class="lev-btn">10x</button>
                    <button onclick="setLev(50)" id="btnLev50" class="lev-btn">50x</button>
                    <button onclick="setLev(100)" id="btnLev100" class="lev-btn text-rose-300 border-rose-900/50">100x</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <button onclick="executeTrade('buy')" class="bg-gradient-to-b from-emerald-500 to-emerald-700 text-white py-4 rounded-xl font-black text-lg shadow-[0_4px_20px_rgba(16,185,129,0.3)] active:scale-95 transition-transform border border-emerald-400/50">
                LONG / BUY
            </button>
            <button onclick="executeTrade('sell')" class="bg-gradient-to-b from-rose-500 to-rose-700 text-white py-4 rounded-xl font-black text-lg shadow-[0_4px_20px_rgba(244,63,94,0.3)] active:scale-95 transition-transform border border-rose-400/50">
                CLOSE ALL
            </button>
        </div>
        <p class="text-center text-[9px] text-purple-500/70 mt-4 mono font-bold">SIMULATION ENGINE ‚Ä¢ LIQUIDATION ACTIVE</p>
    </div>

    <script>
        const user = localStorage.getItem("currentUser") || "GUEST";
        const p = user + "_";
        let isPanic = localStorage.getItem("forjax_panic_mode") === "true";
        let currentBtcPrice = 96000;
        let selectedLeverage = 1;
        
        // AUDIO ENGINE (V2)
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let ctx;
        const sfx = {
            play: (freq, type, dur, vol) => {
                if(!ctx) { ctx = new AudioCtx(); }
                if(ctx.state === 'suspended') ctx.resume();
                const osc = ctx.createOscillator(); const gain = ctx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, ctx.currentTime);
                gain.gain.setValueAtTime(vol, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + dur);
                osc.connect(gain); gain.connect(ctx.destination);
                osc.start(); osc.stop(ctx.currentTime + dur);
            },
            success: () => { sfx.play(800, 'sine', 0.1, 0.1); setTimeout(()=>sfx.play(1600, 'sine', 0.15, 0.1), 100); },
            error: () => { sfx.play(200, 'sawtooth', 0.2, 0.1); setTimeout(()=>sfx.play(150, 'sawtooth', 0.3, 0.1), 150); },
            tap: () => sfx.play(1000, 'square', 0.03, 0.05),
            liquidated: () => { 
                sfx.play(150, 'sawtooth', 0.5, 0.2); 
                setTimeout(()=>sfx.play(100, 'sawtooth', 0.8, 0.2), 200);
                if(navigator.vibrate) navigator.vibrate([200,100,300]);
            }
        };

        // TRADING LOGIC (MARGIN)
        // marginUsd: Plata real bloqueada. btcSize: Exposici√≥n total (con leverage)
        let portfolio = JSON.parse(localStorage.getItem('forjax_angel_portfolio')) || { usd: 10000, btcSize: 0, marginUsd: 0, entryPrice: 0, lev: 1 };
        
        function savePortfolio() { localStorage.setItem('forjax_angel_portfolio', JSON.stringify(portfolio)); updatePortfolioUI(); }

        function updatePortfolioUI() {
            document.getElementById('paperUsd').innerText = `$${portfolio.usd.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
            document.getElementById('paperBtc').innerText = portfolio.btcSize.toFixed(4);
            document.getElementById('modalAvail').innerText = `$${portfolio.usd.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
            
            const levBadge = document.getElementById('activeLev');
            if(portfolio.btcSize > 0) {
                levBadge.style.display = 'inline-block';
                levBadge.innerText = `x${portfolio.lev}`;
                
                // PnL = (Current - Entry) * BTC_Amount
                const pnl = (currentBtcPrice - portfolio.entryPrice) * portfolio.btcSize;
                
                // LIQUIDATION CHECK
                if (pnl <= -portfolio.marginUsd) {
                    liquidatePosition();
                    return;
                }

                const el = document.getElementById('paperPnl');
                el.innerText = `${pnl >= 0 ? '+' : ''}$${pnl.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
                el.className = `text-sm font-black mono ${pnl >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;
                
                // Visual Warning if close to liquidation (loss > 70% of margin)
                const liqWarn = document.getElementById('liqWarning');
                if (pnl < -(portfolio.marginUsd * 0.7)) {
                    liqWarn.style.opacity = '1';
                } else {
                    liqWarn.style.opacity = '0';
                }
            } else {
                levBadge.style.display = 'none';
                document.getElementById('paperPnl').innerText = "$0.00";
                document.getElementById('paperPnl').className = "text-sm font-black mono text-slate-500";
                document.getElementById('liqWarning').style.opacity = '0';
            }
        }

        function liquidatePosition() {
            sfx.liquidated();
            showToast('üö® POSITION LIQUIDATED! MARGIN LOST', 'error');
            // Pierde el margen. El USD balance ya hab√≠a sido descontado, as√≠ que solo reseteamos la posici√≥n.
            portfolio.btcSize = 0;
            portfolio.marginUsd = 0;
            portfolio.entryPrice = 0;
            savePortfolio();
        }

        // UI & UTILS
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            let icon = '<i data-lucide="info" class="w-5 h-5 text-purple-400"></i>';
            if(type === 'success') icon = '<i data-lucide="check-circle" class="w-5 h-5 text-emerald-400"></i>';
            if(type === 'error') icon = '<i data-lucide="alert-triangle" class="w-5 h-5 text-rose-500"></i>';
            toast.innerHTML = `${icon} <span class="text-xs font-bold text-white mono">${msg}</span>`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => { toast.style.animation = 'slideDown 0.3s reverse forwards'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            startClock();
            loadUserLiquidity();
            initTradingView();
            fetchMarket();
            updatePortfolioUI();
            
            if(isPanic) { document.getElementById('privacyLayer').classList.add('active'); document.getElementById('btnPanic').classList.add('active'); }
        });

        function loadUserLiquidity() {
            const rec = JSON.parse(localStorage.getItem(p + "records")) || [];
            const net = rec.reduce((a,c) => c.type === 'income' ? a+c.amount : a-c.amount, 0);
            document.getElementById('netVal').innerText = "$" + net.toLocaleString('es-AR', { notation: "compact" });
        }

        async function fetchMarket() {
            try {
                const r1 = await fetch("https://dolarapi.com/v1/dolares/blue");
                const d1 = await r1.json();
                document.getElementById('dolarVal').innerText = `$${d1.venta}`;
                
                const r2 = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum&vs_currencies=usd&include_24hr_change=true");
                const d2 = await r2.json();
                
                currentBtcPrice = d2.bitcoin.usd;
                document.getElementById('btcVal').innerText = `$${currentBtcPrice.toLocaleString()}`;
                const btcChg = d2.bitcoin.usd_24h_change.toFixed(2);
                document.getElementById('btcPct').innerText = `${btcChg}%`;
                document.getElementById('btcPct').className = `text-[10px] mono font-bold bg-black/40 px-1 py-0.5 rounded border border-white/5 ${btcChg>=0?'up':'down'}`;

                document.getElementById('ethVal').innerText = `$${d2.ethereum.usd.toLocaleString()}`;
                const ethChg = d2.ethereum.usd_24h_change.toFixed(2);
                document.getElementById('ethPct').innerText = `${ethChg}%`;
                document.getElementById('ethPct').className = `text-[10px] mono font-bold bg-black/40 px-1 py-0.5 rounded border border-white/5 ${ethChg>=0?'up':'down'}`;
                
                updatePortfolioUI();
            } catch(e) {}
        }

        // CHART & SMA ENGINE
        function initTradingView() {
            const container = document.getElementById('chartContainer');
            const chart = LightweightCharts.createChart(container, {
                layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#64748b' },
                grid: { vertLines: { color: 'rgba(139, 92, 246, 0.05)' }, horzLines: { color: 'rgba(139, 92, 246, 0.05)' } },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                rightPriceScale: { borderVisible: false },
                timeScale: { borderVisible: false, timeVisible: true, secondsVisible: false },
            });

            const series = chart.addCandlestickSeries({
                upColor: '#10b981', downColor: '#f43f5e', borderVisible: false, wickUpColor: '#10b981', wickDownColor: '#f43f5e',
            });
            
            // SMA Line (Angel touch)
            const smaSeries = chart.addLineSeries({ color: 'rgba(192, 132, 252, 0.8)', lineWidth: 2, crosshairMarkerVisible: false });

            let data = [];
            let smaData = [];
            let time = Math.floor(Date.now() / 1000) - 100 * 60;
            let open = 95000;
            
            // Generate Data
            for (let i = 0; i < 100; i++) {
                let close = open + (Math.random() - 0.5) * 300;
                let high = Math.max(open, close) + Math.random() * 50;
                let low = Math.min(open, close) - Math.random() * 50;
                data.push({ time: time + i * 60, open, high, low, close });
                open = close;
            }

            // Calc SMA (10 periods)
            for (let i = 0; i < data.length; i++) {
                if(i < 9) continue;
                let sum = 0;
                for(let j=0; j<10; j++) sum += data[i-j].close;
                smaData.push({ time: data[i].time, value: sum/10 });
            }

            series.setData(data);
            smaSeries.setData(smaData);

            // Live Update Loop
            setInterval(() => {
                const last = data[data.length - 1];
                let nextClose = last.close + (Math.random() - 0.5) * 60;
                let newCandle = {
                    time: last.time + 60,
                    open: last.close, high: Math.max(last.close, nextClose)+15, low: Math.min(last.close, nextClose)-15, close: nextClose
                };
                series.update(newCandle);
                
                // Update SMA
                data.push(newCandle);
                data.shift(); // keep size 100
                let sum = 0;
                for(let j=data.length-1; j>=data.length-10; j--) sum += data[j].close;
                smaSeries.update({ time: newCandle.time, value: sum/10 });

                currentBtcPrice = nextClose;
                updatePortfolioUI();
                updateSentiment(data);
            }, 1000);
            
            new ResizeObserver(entries => {
                if(entries.length===0 || entries[0].target!==container) return;
                chart.applyOptions({ height: entries[0].contentRect.height, width: entries[0].contentRect.width });
            }).observe(container);
        }

        // SENTIMENT AI
        function updateSentiment(data) {
            // Analiza las ultimas 5 velas
            let bullishCount = 0;
            for(let i=data.length-1; i>=data.length-5; i--) {
                if(data[i].close > data[i].open) bullishCount++;
            }
            // Add some randomness
            let pct = (bullishCount / 5) * 100;
            pct = pct + (Math.random()*10 - 5);
            if(pct < 5) pct = 5; if(pct > 95) pct = 95;

            document.getElementById('sentimentMarker').style.left = `${pct}%`;
            
            let txt = "NEUTRAL"; let col = "#fff";
            if(pct > 65) { txt = "BULLISH (BUY)"; col = "#10b981"; }
            else if(pct < 35) { txt = "BEARISH (SELL)"; col = "#f43f5e"; }
            
            const el = document.getElementById('sentimentText');
            el.innerText = `AI: ${txt}`;
            el.style.color = col;
        }

        // TRADE UI
        function openTrade() { sfx.tap(); document.getElementById('tradeModal').classList.add('open'); }
        function closeTrade() { sfx.tap(); document.getElementById('tradeModal').classList.remove('open'); }
        
        function setLev(val) {
            sfx.tap();
            selectedLeverage = val;
            [1, 10, 50, 100].forEach(l => {
                const b = document.getElementById(`btnLev${l}`);
                if(l === val) b.classList.add('active'); else b.classList.remove('active');
            });
            if(val === 100) showToast('‚ö†Ô∏è EXTREME RISK ACTIVATED', 'info');
        }

        function executeTrade(type) {
            if(type === 'sell') {
                // CLOSE POSITION
                if(portfolio.btcSize <= 0) { sfx.error(); showToast('NO ACTIVE POSITIONS', 'error'); return; }
                
                const pnl = (currentBtcPrice - portfolio.entryPrice) * portfolio.btcSize;
                // Devolvemos el margen original + la ganancia/perdida
                portfolio.usd += (portfolio.marginUsd + pnl);
                portfolio.btcSize = 0;
                portfolio.marginUsd = 0;
                portfolio.entryPrice = 0;
                
                sfx.success();
                showToast(`POSITION CLOSED. P&L: $${pnl.toFixed(2)}`, pnl >= 0 ? 'success' : 'error');
                savePortfolio();
                closeTrade();
                return;
            }

            // BUY / LONG
            if(portfolio.btcSize > 0) {
                sfx.error(); showToast('CLOSE ACTIVE POSITION FIRST', 'error'); return;
            }

            const amountUsd = parseFloat(document.getElementById('tradeAmount').value); // This is MARGIN
            if(isNaN(amountUsd) || amountUsd <= 0) { sfx.error(); showToast('INVALID AMOUNT', 'error'); return; }
            if(amountUsd > portfolio.usd) { sfx.error(); showToast('INSUFFICIENT FUNDS', 'error'); return; }

            // Apply Leverage
            const exposureUsd = amountUsd * selectedLeverage;
            const btcBought = exposureUsd / currentBtcPrice;
            
            portfolio.marginUsd = amountUsd;
            portfolio.usd -= amountUsd; // Bloqueamos el margen
            portfolio.btcSize = btcBought;
            portfolio.entryPrice = currentBtcPrice;
            portfolio.lev = selectedLeverage;
            
            sfx.success();
            showToast(`LONG ${selectedLeverage}x OPENED (${btcBought.toFixed(3)} BTC)`, 'success');
            savePortfolio();
            closeTrade();
        }

        // PANIC
        function togglePanic() {
            sfx.tap();
            isPanic = !isPanic;
            localStorage.setItem("forjax_panic_mode", isPanic);
            
            const layer = document.getElementById('privacyLayer');
            const btn = document.getElementById('btnPanic');

            if(isPanic) {
                layer.classList.add('active'); btn.classList.add('active');
                if(navigator.vibrate) navigator.vibrate([100,50,100]);
            } else {
                layer.classList.remove('active'); btn.classList.remove('active');
                if(navigator.vibrate) navigator.vibrate(50);
                showToast('BIOMETRIC OVERRIDE ACCEPTED', 'success');
            }
        }

        function startClock() { setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000); }
    </script>
</body>
</html>
