<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FORJAX Terminal - V10 The Auditor</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: { 
                        dark: '#0f172a',
                        primary: '#3b82f6',
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap');
        
        body { font-family: 'Outfit', sans-serif; transition: all 0.3s ease; }
        
        /* Glassmorphism Premium */
        .glass { backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.08); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .dark .glass { background: rgba(15, 23, 42, 0.7); border-color: rgba(255,255,255,0.05); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); }
        .light .glass { background: rgba(255, 255, 255, 0.8); border-color: rgba(0,0,0,0.05); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); }

        .hover-scale:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,0,0,0.2); }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .dark input, .dark select { background: #1e293b; color: #fff; border: 1px solid #334155; }
        .dark input::placeholder { color: #94a3b8; }
        .dark option { background-color: #0f172a; color: white; }
        .light input, .light select { background: #f1f5f9; color: #1e293b; border: 1px solid #cbd5e1; }
        
        .crypto-pulse { animation: cryptoPulse 2s infinite; }
        @keyframes cryptoPulse { 0% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(168, 85, 247, 0); } 100% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0); } }
    </style>
</head>

<body class="min-h-screen pb-10 transition-colors duration-500 bg-slate-100 text-slate-900 dark:bg-[#0B1121] dark:text-slate-100 selection:bg-blue-500 selection:text-white">

<div id="loginScreen" class="fixed inset-0 z-[60] flex items-center justify-center bg-[#0B1121] transition-all duration-500">
    <div class="relative w-full max-w-md p-8 text-center fade-in">
        <div class="absolute inset-0 bg-blue-600/20 blur-[100px] rounded-full"></div>
        <div class="glass relative p-10 rounded-3xl border border-white/10">
            <div class="mb-8 inline-flex p-5 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-2xl shadow-2xl shadow-blue-600/20">
                <i data-lucide="layout-dashboard" class="w-10 h-10 text-white"></i>
            </div>
            <h2 class="text-4xl font-extrabold mb-2 tracking-tight">FORJAX <span class="text-blue-500">TERMINAL</span></h2>
            <p class="text-slate-400 mb-8 font-medium">Sistema de Inteligencia Financiera</p>
            <input id="userInput" type="text" placeholder="Identificaci贸n de Agente" class="w-full p-4 rounded-xl mb-4 text-center text-lg font-bold outline-none focus:ring-2 focus:ring-blue-500 transition-all">
            <button onclick="app.initSession()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg hover:shadow-blue-600/40">ACCEDER</button>
        </div>
    </div>
</div>

<div id="mainApp" class="hidden opacity-0 transition-opacity duration-700">
    
    <nav class="fixed top-6 left-1/2 -translate-x-1/2 z-50 glass px-2 py-2 rounded-2xl flex items-center gap-1 shadow-2xl overflow-x-auto no-scrollbar max-w-[95vw] md:max-w-none">
        <button onclick="app.switchTab('wallet')" id="btnWallet" class="whitespace-nowrap px-6 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 transition-all bg-blue-600 text-white shadow-lg">
            <i data-lucide="wallet"></i> Billetera
        </button>
        <button onclick="app.switchTab('subs')" id="btnSubs" class="whitespace-nowrap px-6 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 transition-all text-slate-400 hover:text-white hover:bg-white/5">
            <i data-lucide="zap"></i> Subs
        </button>
        <button onclick="app.switchTab('goals')" id="btnGoals" class="whitespace-nowrap px-6 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 transition-all text-slate-400 hover:text-white hover:bg-white/5">
            <i data-lucide="target"></i> Metas
        </button>
        <button onclick="app.switchTab('market')" id="btnMarket" class="whitespace-nowrap px-6 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 transition-all text-slate-400 hover:text-white hover:bg-white/5">
            <i data-lucide="globe"></i> Mercado
        </button>
        <div class="w-px h-6 bg-white/10 mx-2 hidden md:block"></div>
        <button onclick="app.openSettings()" class="p-2.5 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all">
            <i data-lucide="settings" class="w-5 h-5"></i>
        </button>
        <button onclick="app.toggleTheme()" class="p-2.5 rounded-xl text-slate-400 hover:text-yellow-400 hover:bg-white/5 transition-all">
            <i id="themeIcon" data-lucide="sun" class="w-5 h-5"></i>
        </button>
        <button onclick="app.logout()" class="p-2.5 rounded-xl text-slate-400 hover:text-rose-500 hover:bg-white/5 transition-all">
            <i data-lucide="power" class="w-5 h-5"></i>
        </button>
    </nav>

    <div class="pt-28 max-w-[1400px] mx-auto px-6 pb-12">
        
        <div id="viewWallet" class="fade-in">
            <div class="flex justify-between items-center mb-6">
                <div><h2 class="text-2xl font-bold">Dashboard</h2><p class="text-sm text-slate-400">Resumen Financiero</p></div>
                <div class="glass p-1 rounded-xl flex gap-1">
                    <button onclick="app.setFilter('month')" id="filterMonth" class="px-4 py-2 rounded-lg text-xs font-bold transition-all bg-blue-600 text-white shadow-lg">Este Mes</button>
                    <button onclick="app.setFilter('prev')" id="filterPrev" class="px-4 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white hover:bg-white/5">Mes Pasado</button>
                    <button onclick="app.setFilter('all')" id="filterAll" class="px-4 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white hover:bg-white/5">Hist贸rico</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="glass p-6 rounded-3xl border-b-4 border-emerald-500 hover-scale"><p class="text-xs font-bold uppercase tracking-wider opacity-60 mb-1">Ingresos</p><h2 class="text-3xl font-black text-emerald-500" id="bIncome">$0</h2></div>
                <div class="glass p-6 rounded-3xl border-b-4 border-rose-500 hover-scale"><p class="text-xs font-bold uppercase tracking-wider opacity-60 mb-1">Gastos</p><h2 class="text-3xl font-black text-rose-500" id="bExpense">$0</h2></div>
                <div class="glass p-6 rounded-3xl border-b-4 border-blue-500 hover-scale"><p class="text-xs font-bold uppercase tracking-wider opacity-60 mb-1">Balance</p><h2 class="text-3xl font-black text-blue-500" id="bNet">$0</h2></div>
                <div class="glass p-6 rounded-3xl border-b-4 border-violet-500 hover-scale flex flex-col justify-center"><p class="text-xs font-bold uppercase tracking-wider opacity-60 mb-1">Capital USD</p><div class="flex items-baseline gap-2"><h2 class="text-3xl font-black text-white" id="capitalUsd">US$ 0</h2><span class="text-xs text-emerald-400 font-bold bg-emerald-500/10 px-2 py-1 rounded" id="dolarRateTag">...</span></div></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-4 space-y-6">
                    <div class="glass p-6 rounded-3xl">
                        <h3 class="flex items-center gap-2 text-lg font-bold mb-6 text-blue-500"><i data-lucide="mouse-pointer-2"></i> Operaciones</h3>
                        <div class="space-y-4">
                            <div class="relative"><i data-lucide="type" class="absolute left-4 top-3.5 w-5 h-5 opacity-50"></i><input id="transDesc" type="text" placeholder="Descripci贸n" class="w-full pl-12 p-3 rounded-xl font-medium outline-none focus:ring-2 focus:ring-blue-500 transition-all"></div>
                            <div class="flex gap-3">
                                <div class="relative w-1/2"><i data-lucide="dollar-sign" class="absolute left-3 top-3.5 w-5 h-5 opacity-50"></i><input id="transAmount" type="number" placeholder="Monto" class="w-full pl-10 p-3 rounded-xl font-medium outline-none focus:ring-2 focus:ring-blue-500 transition-all"></div>
                                <select id="transCategory" class="w-1/2 p-3 rounded-xl font-medium outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer"><option value="Ingreso"> Ingreso</option><option value="Hogar"> Hogar</option><option value="Comida"> Comida</option><option value="Servicios"> Servicios</option><option value="Transporte"> Transporte</option><option value="Ocio"> Ocio</option><option value="Salud">わ Salud</option><option value="Educaci贸n"> Educaci贸n</option><option value="Otros"> Otros</option></select>
                            </div>
                            <div class="grid grid-cols-2 gap-3 pt-2">
                                <button onclick="app.addRecord('income')" class="bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold transition-all shadow-lg active:scale-95 flex justify-center items-center gap-2"><i data-lucide="plus"></i> INGRESO</button>
                                <button onclick="app.addRecord('expense')" class="bg-rose-600 hover:bg-rose-500 text-white py-3 rounded-xl font-bold transition-all shadow-lg active:scale-95 flex justify-center items-center gap-2"><i data-lucide="minus"></i> GASTO</button>
                            </div>
                        </div>
                        
                        <div class="mt-8 pt-6 border-t border-white/10">
                            <div class="flex justify-between items-end mb-2"><div><h4 class="font-bold text-base text-blue-400 uppercase tracking-wide flex items-center gap-2"><i data-lucide="target" class="w-4 h-4"></i> Presupuesto</h4></div><span id="budgetPercent" class="text-lg font-black text-white bg-blue-600 px-2 py-0.5 rounded-lg">0%</span></div>
                            <div class="w-full bg-slate-700/50 rounded-full h-4 mb-3 overflow-hidden border border-white/5"><div id="budgetBar" class="bg-blue-500 h-4 rounded-full transition-all duration-1000 relative" style="width: 0%"><div class="absolute inset-0 bg-white/20 animate-pulse"></div></div></div>
                            <div class="flex items-center justify-between bg-black/20 p-2 rounded-xl border border-white/5"><span id="budgetUsed" class="text-xs font-bold text-rose-400">$0</span><input id="budgetInput" onchange="app.setBudget()" type="number" class="bg-transparent text-right outline-none w-24 text-sm font-bold text-emerald-400 placeholder-slate-600" placeholder="$ Global"></div>
                        </div>

                        <div class="mt-8 pt-6 border-t border-white/10">
                            <h4 class="font-bold text-base text-amber-500 uppercase tracking-wide flex items-center gap-2 mb-4"><i data-lucide="siren" class="w-4 h-4"></i> Auditor铆a de Gastos</h4>
                            <p class="text-xs text-slate-400 mb-3">Toca una categor铆a para fijar su l铆mite.</p>
                            <div id="limitsGrid" class="space-y-3 max-h-[300px] overflow-y-auto custom-scroll pr-1">
                                </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass p-5 rounded-3xl"><h4 class="text-xs font-bold uppercase tracking-wider opacity-60 mb-4">Evoluci贸n</h4><div class="h-48"><canvas id="barChart"></canvas></div></div>
                        <div class="glass p-5 rounded-3xl"><h4 class="text-xs font-bold uppercase tracking-wider opacity-60 mb-4">Distribuci贸n</h4><div class="h-48 flex justify-center"><canvas id="pieChart"></canvas></div></div>
                    </div>
                    <div class="glass rounded-3xl overflow-hidden border border-white/5">
                        <div class="p-5 border-b border-white/5 flex flex-wrap justify-between items-center gap-4 bg-white/5">
                            <h3 class="font-bold flex items-center gap-2"><i data-lucide="list"></i> Movimientos</h3>
                            <div class="flex gap-2">
                                <input id="searchInput" onkeyup="app.render()" type="text" placeholder="Buscar..." class="bg-black/20 border-none rounded-lg px-3 py-1.5 text-sm w-32 focus:w-48 transition-all outline-none">
                                <button onclick="app.exportProExcel()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg shadow-emerald-600/20"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i> CFO</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto max-h-[400px] custom-scroll">
                            <table class="w-full text-left border-collapse">
                                <thead class="sticky top-0 bg-[#0f172a] z-10 text-xs uppercase opacity-70 font-bold">
                                    <tr><th class="px-6 py-4">Fecha</th><th class="px-6 py-4">Detalle</th><th class="px-6 py-4">Categor铆a</th><th class="px-6 py-4 text-right">Monto</th><th class="px-6 py-4 text-center">Acci贸n</th></tr>
                                </thead>
                                <tbody id="historyTable" class="divide-y divide-white/5 text-sm font-medium"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="viewSubs" class="hidden fade-in">
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div><h2 class="text-2xl font-bold flex items-center gap-2"><i data-lucide="zap" class="text-yellow-500"></i> Gastos Fijos</h2><p class="text-sm text-slate-400">Piloto Autom谩tico</p></div>
                <button onclick="app.toggleSubForm()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition-all flex items-center gap-2"><i data-lucide="plus-circle"></i> Nueva Suscripci贸n</button>
            </div>
            <div id="subForm" class="hidden glass p-6 rounded-3xl mb-8 border border-blue-500/30">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="md:col-span-1"><label class="text-xs text-slate-500 mb-1 block">Nombre</label><input id="subName" type="text" class="w-full p-3 rounded-xl font-bold outline-none focus:ring-2 focus:ring-blue-500"></div>
                    <div class="md:col-span-1"><label class="text-xs text-slate-500 mb-1 block">Monto</label><input id="subAmount" type="number" class="w-full p-3 rounded-xl font-bold outline-none focus:ring-2 focus:ring-blue-500"></div>
                    <div class="md:col-span-1"><label class="text-xs text-slate-500 mb-1 block">D铆a Venc (1-31)</label><input id="subDay" type="number" min="1" max="31" class="w-full p-3 rounded-xl font-bold outline-none focus:ring-2 focus:ring-blue-500"></div>
                    <div class="md:col-span-1"><button onclick="app.addSub()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white p-3 rounded-xl font-bold transition-all">Guardar</button></div>
                </div>
            </div>
            <div class="mb-8 p-4 rounded-2xl bg-slate-800/50 border border-white/5 flex justify-between items-center"><span class="text-slate-400 font-medium">Total Costos Fijos:</span><span id="totalSubs" class="text-2xl font-black text-white">$0</span></div>
            <div id="subsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>

        <div id="viewGoals" class="hidden fade-in">
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div><h2 class="text-2xl font-bold flex items-center gap-2"><i data-lucide="trophy" class="text-yellow-500"></i> Cazador de Sue帽os</h2><p class="text-sm text-slate-400">Objetivos Financieros</p></div>
                <button onclick="app.addGoalPrompt()" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-purple-500/30 transition-all flex items-center gap-2"><i data-lucide="star"></i> Crear Meta</button>
            </div>
            <div id="goalsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div id="viewMarket" class="hidden fade-in">
            <div class="flex items-center justify-between mb-8">
                <div><h2 class="text-3xl font-black tracking-tight text-white flex items-center gap-2"><i data-lucide="globe-2" class="text-blue-500"></i> Mercado Global</h2><p class="text-slate-400">Fiat & Cripto en tiempo real</p></div>
                <div class="text-right"><button onclick="app.fetchFullMarket()" class="bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 p-3 rounded-xl transition-all"><i data-lucide="refresh-cw" id="refreshIcon" class="w-6 h-6"></i></button></div>
            </div>

            <div class="glass p-6 rounded-3xl mb-10 border-l-4 border-blue-500">
                <h3 class="text-sm font-bold uppercase tracking-wider text-blue-400 mb-4 flex items-center gap-2"><i data-lucide="calculator" class="w-4 h-4"></i> Convertidor Universal</h3>
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <div class="flex-1 w-full"><label class="text-xs text-slate-500 mb-1 block">Monto</label><input id="calcAmount" type="number" value="1" onkeyup="app.calcCurrency()" class="w-full p-3 rounded-xl text-lg font-bold outline-none focus:ring-2 focus:ring-blue-500 transition-all"></div>
                    <div class="flex-1 w-full"><label class="text-xs text-slate-500 mb-1 block">De</label><select id="calcFrom" onchange="app.calcCurrency()" class="w-full p-3 rounded-xl font-bold cursor-pointer outline-none focus:ring-2 focus:ring-blue-500 text-white bg-slate-800"></select></div>
                    <div class="flex items-center justify-center pt-5"><button onclick="app.swapCalc()" class="p-2 rounded-full bg-white/5 hover:bg-white/10 transition-all"><i data-lucide="arrow-right-left" class="w-5 h-5 text-slate-400"></i></button></div>
                    <div class="flex-1 w-full"><label class="text-xs text-slate-500 mb-1 block">A</label><select id="calcTo" onchange="app.calcCurrency()" class="w-full p-3 rounded-xl font-bold cursor-pointer outline-none focus:ring-2 focus:ring-blue-500 text-white bg-slate-800"></select></div>
                    <div class="flex-1 w-full bg-blue-600/10 p-3 rounded-xl border border-blue-500/20 text-center"><p class="text-xs text-blue-400 uppercase font-bold mb-1">Resultado</p><p id="calcResult" class="text-2xl font-black text-white">...</p></div>
                </div>
            </div>

            <h3 class="text-xl font-bold text-white mb-4 pl-2 border-l-4 border-purple-500 flex items-center gap-2"> Criptomonedas (Live)</h3>
            <div id="marketGridCrypto" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10"></div>
            <h3 class="text-xl font-bold text-white mb-4 pl-2 border-l-4 border-emerald-500"> Argentina</h3>
            <div id="marketGridArg" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10"></div>
            <h3 class="text-xl font-bold text-white mb-4 pl-2 border-l-4 border-blue-500"> Divisas Mundiales (Forex)</h3>
            <div id="marketGridWorld" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
        </div>
    </div>
</div>

<input type="file" id="importFile" class="hidden" accept=".json" onchange="app.restoreData(this)">

<script>
/* ====================== CORE DEL SISTEMA ====================== */
const app = {
    user: localStorage.getItem("currentUser"),
    theme: localStorage.getItem("theme") || 'dark',
    currentTab: 'wallet',
    timeFilter: 'month', 
    data: { records: [], budget: 0, subs: [], goals: [], limits: {} }, // V10: limits added
    rates: {}, charts: {},

    init() {
        this.applyTheme();
        if (!this.user) {
            document.getElementById("loginScreen").classList.remove("hidden");
        } else {
            document.getElementById("loginScreen").classList.add("hidden");
            document.getElementById("mainApp").classList.remove("hidden");
            setTimeout(() => document.getElementById("mainApp").classList.remove("opacity-0"), 100);
            
            this.loadData();
            this.render();
            this.renderSubs();
            this.renderGoals();
            this.fillCalcSelects();
            this.fetchDolarSimple();
            this.fetchFullMarket();
            lucide.createIcons();
        }
    },

    switchTab(tab) {
        this.currentTab = tab;
        const views = { wallet: document.getElementById("viewWallet"), subs: document.getElementById("viewSubs"), goals: document.getElementById("viewGoals"), market: document.getElementById("viewMarket") };
        const btns = { wallet: document.getElementById("btnWallet"), subs: document.getElementById("btnSubs"), goals: document.getElementById("btnGoals"), market: document.getElementById("btnMarket") };
        const activeClass = "bg-blue-600 text-white shadow-lg";
        const inactiveClass = "text-slate-400 hover:text-white hover:bg-white/5";
        const baseClass = "whitespace-nowrap px-6 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 transition-all ";

        Object.values(views).forEach(v => v.classList.add("hidden"));
        Object.values(btns).forEach(b => b.className = baseClass + inactiveClass);
        views[tab].classList.remove("hidden");
        btns[tab].className = baseClass + activeClass;

        if (tab === 'market') this.fetchFullMarket();
    },

    setFilter(filter) {
        this.timeFilter = filter;
        const btns = { 'month': document.getElementById("filterMonth"), 'prev': document.getElementById("filterPrev"), 'all': document.getElementById("filterAll") };
        const activeClass = "bg-blue-600 text-white shadow-lg";
        const inactiveClass = "text-slate-400 hover:text-white hover:bg-white/5";
        Object.keys(btns).forEach(key => btns[key].className = `px-4 py-2 rounded-lg text-xs font-bold transition-all ${key === filter ? activeClass : inactiveClass}`);
        this.render();
    },

    loadData() {
        const prefix = this.user + "_";
        this.data.records = JSON.parse(localStorage.getItem(prefix + "records")) || [];
        this.data.budget = Number(localStorage.getItem(prefix + "budget")) || 0;
        this.data.subs = JSON.parse(localStorage.getItem(prefix + "subs")) || [];
        this.data.goals = JSON.parse(localStorage.getItem(prefix + "goals")) || [];
        this.data.limits = JSON.parse(localStorage.getItem(prefix + "limits")) || {}; // Cargar Limites
    },

    save() {
        const prefix = this.user + "_";
        localStorage.setItem(prefix + "records", JSON.stringify(this.data.records));
        localStorage.setItem(prefix + "budget", this.data.budget);
        localStorage.setItem(prefix + "subs", JSON.stringify(this.data.subs));
        localStorage.setItem(prefix + "goals", JSON.stringify(this.data.goals));
        localStorage.setItem(prefix + "limits", JSON.stringify(this.data.limits)); // Guardar Limites
        this.render();
    },

    /* --- WALLET LOGIC --- */
    addRecord(type) {
        const desc = document.getElementById("transDesc").value;
        const amount = Number(document.getElementById("transAmount").value);
        const category = document.getElementById("transCategory").value;
        if (!desc || amount <= 0) return Swal.fire({toast:true, position:'top', icon:'warning', title:'Faltan datos', showConfirmButton:false, timer:2000});
        
        // CHECK LIMITS (V10 Feature)
        if(type === 'expense' && this.data.limits[category]) {
            const currentSpent = this.getCategorySpent(category);
            const limit = this.data.limits[category];
            if(currentSpent + amount > limit) {
                Swal.fire({
                    title: '隆ALERTA DE GASTO!',
                    text: `Te est谩s pasando del l铆mite de ${category} ($${limit})`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Gastar igual',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) this.executeAddRecord(desc, amount, category, type);
                });
                return;
            }
        }
        this.executeAddRecord(desc, amount, category, type);
    },

    executeAddRecord(desc, amount, category, type) {
        this.data.records.unshift({ id: Date.now(), date: new Date().toLocaleDateString(), desc, amount, category, type });
        document.getElementById("transDesc").value = ""; document.getElementById("transAmount").value = ""; this.save();
        Swal.fire({toast:true, position:'bottom-end', icon:'success', title:'Operaci贸n Registrada', showConfirmButton:false, timer:2000});
    },

    deleteRecord(id) { this.data.records = this.data.records.filter(r => r.id !== id); this.save(); },
    setBudget() { this.data.budget = Number(document.getElementById("budgetInput").value); this.save(); },

    /* --- V10 AUDITOR LOGIC --- */
    async setCategoryLimit(cat) {
        const { value: limit } = await Swal.fire({
            title: `L铆mite para ${cat}`,
            input: 'number',
            inputValue: this.data.limits[cat] || '',
            inputPlaceholder: 'Monto m谩ximo mensual',
            showCancelButton: true,
            confirmButtonText: 'Guardar'
        });

        if (limit !== undefined) {
            if(limit === "") delete this.data.limits[cat];
            else this.data.limits[cat] = Number(limit);
            this.save();
        }
    },

    getCategorySpent(cat) {
        // Siempre calcula gasto del MES ACTUAL para los l铆mites
        const now = new Date();
        const m = now.getMonth();
        const y = now.getFullYear();
        return this.data.records.filter(r => {
            const [d, rm, ry] = r.date.split('/').map(Number);
            return r.category === cat && r.type === 'expense' && (rm - 1) === m && ry === y;
        }).reduce((a,c) => a + c.amount, 0);
    },

    renderCategoryLimits() {
        const container = document.getElementById("limitsGrid");
        const categories = ["Hogar", "Comida", "Servicios", "Transporte", "Ocio", "Salud", "Educaci贸n", "Otros"];
        const formatter = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 });

        container.innerHTML = categories.map(cat => {
            const limit = this.data.limits[cat] || 0;
            const spent = this.getCategorySpent(cat);
            const percent = limit > 0 ? (spent / limit) * 100 : 0;
            
            // Color logic
            let color = "bg-blue-500";
            let textColor = "text-slate-400";
            if(limit > 0) {
                if(percent > 100) { color = "bg-rose-500"; textColor = "text-rose-500 font-bold"; }
                else if(percent > 80) { color = "bg-amber-500"; textColor = "text-amber-500 font-bold"; }
                else { color = "bg-emerald-500"; textColor = "text-emerald-500"; }
            }

            return `
            <div onclick="app.setCategoryLimit('${cat}')" class="bg-black/20 p-3 rounded-xl border border-white/5 hover:bg-white/5 cursor-pointer transition-all group">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-sm text-white group-hover:text-blue-400 transition-colors">${cat}</span>
                    <span class="text-xs ${textColor}">${limit > 0 ? (percent > 100 ? 'EXCEDIDO' : Math.round(percent)+'%') : 'Sin L铆mite'}</span>
                </div>
                <div class="w-full bg-slate-700/50 h-2 rounded-full overflow-hidden mb-2">
                    <div class="${color} h-full transition-all" style="width: ${Math.min(percent, 100)}%"></div>
                </div>
                <div class="flex justify-between text-xs">
                    <span class="text-slate-400">${formatter.format(spent)}</span>
                    <span class="text-slate-500">${limit > 0 ? formatter.format(limit) : '-'}</span>
                </div>
            </div>`;
        }).join('');
    },

    /* --- SUBS --- */
    toggleSubForm() { document.getElementById("subForm").classList.toggle("hidden"); },
    addSub() {
        const name = document.getElementById("subName").value;
        const amount = Number(document.getElementById("subAmount").value);
        const day = Number(document.getElementById("subDay").value);
        if(!name || amount <= 0 || day < 1 || day > 31) return Swal.fire("Error", "Datos inv谩lidos", "error");
        if(!this.data.subs) this.data.subs = [];
        this.data.subs.push({ id: Date.now(), name, amount, day });
        this.save(); this.renderSubs(); document.getElementById("subName").value = ""; document.getElementById("subAmount").value = ""; this.toggleSubForm();
    },
    deleteSub(id) { Swal.fire({title: '驴Eliminar?', showCancelButton: true, confirmButtonColor: '#d33'}).then((r) => { if (r.isConfirmed) { this.data.subs = this.data.subs.filter(s => s.id !== id); this.save(); this.renderSubs(); }}); },
    paySub(id) {
        const sub = this.data.subs.find(s => s.id === id); if(!sub) return;
        this.addRecord('expense', `Pago: ${sub.name}`, sub.amount, 'Servicios'); // Reuse updated addRecord logic? No, direct push better for automation to avoid alerts loop or handle differently.
        // Direct push for subs to avoid prompt loop, but we want it recorded.
        this.data.records.unshift({ id: Date.now(), date: new Date().toLocaleDateString(), desc: `Pago: ${sub.name}`, amount: sub.amount, category: 'Servicios', type: 'expense' });
        this.save(); this.renderSubs(); this.render(); Swal.fire({toast:true, position:'top-end', icon:'success', title:`隆${sub.name} Pagado!`, showConfirmButton:false, timer:2000});
    },
    renderSubs() {
        const grid = document.getElementById("subsGrid"); const formatter = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 });
        const now = new Date(); const currentMonth = now.getMonth(); const currentYear = now.getFullYear(); const today = now.getDate();
        if(!this.data.subs || this.data.subs.length === 0) { grid.innerHTML = `<div class="col-span-full text-center py-20 text-slate-500 opacity-50"><i data-lucide="zap-off" class="w-16 h-16 mx-auto mb-4"></i><p>Sin suscripciones</p></div>`; document.getElementById("totalSubs").textContent = "$0"; return; }
        let totalFixed = 0;
        grid.innerHTML = this.data.subs.map(s => {
            totalFixed += s.amount;
            const isPaid = this.data.records.some(r => { const [d, m, y] = r.date.split('/').map(Number); return (m - 1) === currentMonth && y === currentYear && r.desc === `Pago: ${s.name}`; });
            let daysLeft = s.day - today; let statusColor = "text-emerald-400"; let statusText = `Vence en ${daysLeft} d铆as`;
            if(daysLeft < 0) { if(isPaid) { statusText = "Pagado"; statusColor = "text-slate-400"; } else { statusText = "VENCIDO"; statusColor = "text-rose-500 font-black"; } } else if (daysLeft === 0) { statusText = "VENCE HOY"; statusColor = "text-yellow-400 font-black animate-pulse"; }
            return `<div class="glass p-5 rounded-2xl relative group hover:bg-white/5 transition-all border ${isPaid ? 'border-emerald-500/30' : 'border-slate-700'}"><button onclick="app.deleteSub(${s.id})" class="absolute top-4 right-4 text-slate-500 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="trash-2" class="w-4 h-4"></i></button><div class="flex items-center gap-3 mb-4"><div class="p-3 rounded-xl ${isPaid ? 'bg-emerald-500/20 text-emerald-400' : 'bg-blue-500/20 text-blue-400'}"><i data-lucide="${isPaid ? 'check-circle-2' : 'calendar-clock'}" class="w-6 h-6"></i></div><div><h3 class="font-bold text-lg text-white">${s.name}</h3><p class="text-xs ${statusColor}">${statusText}</p></div></div><div class="flex justify-between items-end"><div><p class="text-[10px] uppercase font-bold text-slate-500">Monto</p><p class="text-2xl font-black text-white">${formatter.format(s.amount)}</p></div>${!isPaid ? `<button onclick="app.paySub(${s.id})" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-xs shadow-lg shadow-blue-600/20 transition-all active:scale-95">PAGAR</button>` : `<span class="text-xs font-bold text-emerald-500 bg-emerald-500/10 px-3 py-1 rounded-lg border border-emerald-500/20">PAGADO</span>`}</div><div class="mt-3 w-full bg-slate-700/50 h-1.5 rounded-full overflow-hidden"><div class="bg-blue-500 h-full transition-all" style="width: ${Math.min((today/31)*100, 100)}%"></div></div></div>`;
        }).join('');
        document.getElementById("totalSubs").textContent = formatter.format(totalFixed); lucide.createIcons();
    },

    /* --- GOALS --- */
    async addGoalPrompt() {
        const { value: formValues } = await Swal.fire({ title: 'Nueva Meta', html: '<input id="swal-goal" class="swal2-input" placeholder="Nombre"><input id="swal-target" type="number" class="swal2-input" placeholder="Objetivo ($)">', focusConfirm: false, showCancelButton: true, preConfirm: () => [document.getElementById('swal-goal').value, document.getElementById('swal-target').value] });
        if (formValues && formValues[0] && formValues[1]) { this.data.goals.push({ id: Date.now(), name: formValues[0], target: Number(formValues[1]), current: 0 }); this.save(); this.renderGoals(); Swal.fire({toast:true, icon:'success', title:'Meta creada', position:'top-end', showConfirmButton:false, timer:2000}); }
    },
    async depositGoal(id) {
        const goal = this.data.goals.find(g => g.id === id);
        const { value: amount } = await Swal.fire({ title: `Sumar a ${goal.name}`, input: 'number', showCancelButton: true, confirmButtonText: 'Depositar' });
        if (amount && Number(amount) > 0) { goal.current += Number(amount); this.save(); this.renderGoals(); if(goal.current >= goal.target) { confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); Swal.fire('隆Felicidades!', `Meta alcanzada: ${goal.name}`, 'success'); } }
    },
    deleteGoal(id) { Swal.fire({title: '驴Borrar meta?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33'}).then((r) => { if (r.isConfirmed) { this.data.goals = this.data.goals.filter(g => g.id !== id); this.save(); this.renderGoals(); }}); },
    renderGoals() {
        const grid = document.getElementById("goalsGrid"); const formatter = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 });
        if(!this.data.goals || this.data.goals.length === 0) { grid.innerHTML = `<div class="col-span-full text-center py-20 text-slate-500 opacity-50"><i data-lucide="target" class="w-16 h-16 mx-auto mb-4"></i><p>Sin metas</p></div>`; return; }
        grid.innerHTML = this.data.goals.map(g => {
            const progress = Math.min((g.current / g.target) * 100, 100); const isCompleted = progress >= 100;
            return `<div class="glass p-6 rounded-3xl relative overflow-hidden group hover:scale-[1.02] transition-all border ${isCompleted ? 'border-yellow-400/50 shadow-yellow-500/20 shadow-lg' : 'border-slate-700'}"><button onclick="app.deleteGoal(${g.id})" class="absolute top-4 right-4 text-slate-500 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="trash-2" class="w-4 h-4"></i></button><div class="flex justify-between items-start mb-4"><div class="p-3 rounded-2xl ${isCompleted ? 'bg-yellow-400 text-black' : 'bg-purple-500/20 text-purple-400'}"><i data-lucide="${isCompleted ? 'trophy' : 'rocket'}" class="w-8 h-8"></i></div><div class="text-right"><p class="text-xs font-bold uppercase text-slate-500">Meta</p><p class="text-lg font-bold text-slate-300">${formatter.format(g.target)}</p></div></div><h3 class="text-xl font-bold text-white mb-2">${g.name}</h3><div class="flex justify-between items-end mb-2"><p class="text-3xl font-black ${isCompleted ? 'text-yellow-400' : 'text-white'}">${formatter.format(g.current)}</p><p class="text-sm font-bold ${isCompleted ? 'text-yellow-400' : 'text-purple-400'}">${Math.round(progress)}%</p></div><div class="w-full bg-slate-700/50 h-3 rounded-full overflow-hidden mb-4"><div class="h-full transition-all duration-1000 ${isCompleted ? 'bg-yellow-400' : 'bg-gradient-to-r from-purple-500 to-pink-500'}" style="width: ${progress}%"></div></div><button onclick="app.depositGoal(${g.id})" class="w-full py-3 rounded-xl font-bold flex justify-center items-center gap-2 transition-all ${isCompleted ? 'bg-yellow-400/20 text-yellow-400 cursor-default' : 'bg-white/10 hover:bg-white/20 text-white'}">${isCompleted ? '隆COMPLETADA!' : '<i data-lucide="plus"></i> Depositar'}</button></div>`;
        }).join(''); lucide.createIcons();
    },

    /* --- RENDER --- */
    getFilteredRecords() {
        if (this.timeFilter === 'all') return this.data.records;
        const now = new Date(); const m = now.getMonth(); const y = now.getFullYear();
        return this.data.records.filter(r => { const [d, rm, ry] = r.date.split('/').map(Number); if (this.timeFilter === 'month') return rm - 1 === m && ry === y; if (this.timeFilter === 'prev') { const prev = new Date(y, m - 1, 1); return rm - 1 === prev.getMonth() && ry === prev.getFullYear(); } return true; });
    },
    render() {
        const formatter = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 });
        const rec = this.getFilteredRecords();
        const inc = rec.filter(r => r.type === 'income').reduce((a, c) => a + c.amount, 0);
        const exp = rec.filter(r => r.type === 'expense').reduce((a, c) => a + c.amount, 0);
        const bal = inc - exp;
        document.getElementById("bIncome").textContent = formatter.format(inc); document.getElementById("bExpense").textContent = formatter.format(exp); document.getElementById("bNet").textContent = formatter.format(bal); document.getElementById("bNet").className = `text-3xl font-black ${bal >= 0 ? 'text-blue-500' : 'text-rose-500'}`;
        document.getElementById("budgetInput").value = this.data.budget || ""; if(this.data.budget > 0) { const p = Math.min((exp / this.data.budget) * 100, 100); document.getElementById("budgetBar").style.width = `${p}%`; document.getElementById("budgetPercent").textContent = `${Math.round(p)}%`; document.getElementById("budgetUsed").textContent = `${formatter.format(exp)} Gastados`; }
        const s = document.getElementById("searchInput")?.value.toLowerCase() || ""; const filt = rec.filter(r => r.desc.toLowerCase().includes(s) || r.category.toLowerCase().includes(s));
        const tb = document.getElementById("historyTable"); if (filt.length === 0) tb.innerHTML = `<tr><td colspan="5" class="text-center py-12 opacity-30 font-bold text-lg">SIN DATOS</td></tr>`;
        else tb.innerHTML = filt.map(r => `<tr class="hover:bg-slate-50 dark:hover:bg-white/5 transition-all group border-b border-white/5 last:border-0"><td class="px-6 py-4 opacity-70 text-xs font-bold">${r.date}</td><td class="px-6 py-4 font-bold flex items-center gap-3"><div class="w-8 h-8 rounded-full flex items-center justify-center ${r.type === 'income' ? 'bg-emerald-500/20 text-emerald-500' : 'bg-rose-500/20 text-rose-500'}"><i data-lucide="${r.type === 'income' ? 'arrow-up' : 'shopping-bag'}" class="w-4 h-4"></i></div>${r.desc}</td><td class="px-6 py-4"><span class="px-3 py-1 rounded-lg text-xs font-bold bg-slate-200 dark:bg-white/10 opacity-80">${r.category}</span></td><td class="px-6 py-4 text-right font-black ${r.type === 'income' ? 'text-emerald-500' : 'text-rose-500'}">${r.type === 'income' ? '+' : '-'}${formatter.format(r.amount)}</td><td class="px-6 py-4 text-center"><button onclick="app.deleteRecord(${r.id})" class="text-slate-400 hover:text-rose-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join('');
        if(s === "") this.updateCharts(inc, exp, rec); 
        this.renderCategoryLimits(); // V10 Call
        lucide.createIcons();
    },
   /* --- BACKUP & SETTINGS REFACTORED (DISEO PRO) --- */
    openSettings() {
        Swal.fire({
            title: '<div class="flex flex-col items-center gap-2 mb-2"><div class="p-3 rounded-full bg-blue-500/10 text-blue-400"><i data-lucide="database-zap" class="w-8 h-8"></i></div><span class="text-2xl font-black text-white tracking-tight">DATA CENTER</span></div>',
            html: `
                <div class="grid grid-cols-1 gap-4 mt-2">
                    <button onclick="app.downloadBackup()" class="group relative w-full text-left outline-none">
                        <div class="absolute inset-0 bg-blue-600 rounded-2xl blur opacity-20 group-hover:opacity-50 transition-opacity duration-500"></div>
                        <div class="relative bg-slate-900 border border-blue-500/30 group-hover:border-blue-400 p-5 rounded-2xl flex items-center gap-5 transition-all group-hover:transform group-hover:-translate-y-1 shadow-xl">
                            <div class="h-12 w-12 rounded-xl bg-blue-500/20 flex items-center justify-center text-blue-400 group-hover:bg-blue-500 group-hover:text-white transition-all duration-300">
                                <i data-lucide="download-cloud" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-white text-lg group-hover:text-blue-300 transition-colors">Exportar Backup</h3>
                                <p class="text-xs text-slate-400 group-hover:text-slate-300">Descargar archivo .json encriptado</p>
                            </div>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-600 ml-auto group-hover:text-blue-400 transition-colors"></i>
                        </div>
                    </button>

                    <button onclick="document.getElementById('importFile').click()" class="group relative w-full text-left outline-none">
                        <div class="absolute inset-0 bg-purple-600 rounded-2xl blur opacity-20 group-hover:opacity-50 transition-opacity duration-500"></div>
                        <div class="relative bg-slate-900 border border-purple-500/30 group-hover:border-purple-400 p-5 rounded-2xl flex items-center gap-5 transition-all group-hover:transform group-hover:-translate-y-1 shadow-xl">
                            <div class="h-12 w-12 rounded-xl bg-purple-500/20 flex items-center justify-center text-purple-400 group-hover:bg-purple-500 group-hover:text-white transition-all duration-300">
                                <i data-lucide="upload-cloud" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-white text-lg group-hover:text-purple-300 transition-colors">Restaurar Datos</h3>
                                <p class="text-xs text-slate-400 group-hover:text-slate-300">Importar archivo de respaldo</p>
                            </div>
                             <i data-lucide="chevron-right" class="w-5 h-5 text-slate-600 ml-auto group-hover:text-purple-400 transition-colors"></i>
                        </div>
                    </button>
                </div>
                <div class="mt-6 flex justify-center items-center gap-2 opacity-40">
                    <i data-lucide="shield-check" class="w-3 h-3 text-emerald-500"></i>
                    <span class="text-[10px] uppercase font-bold tracking-widest text-slate-400">Conexi贸n Segura V10.0</span>
                </div>
            `,
            showConfirmButton: false,
            showCloseButton: true,
            background: '#0f172a', // Fondo oscuro para que coincida con la app
            color: '#fff',
            width: '450px',
            padding: '2em',
            customClass: {
                popup: 'border border-slate-700 rounded-3xl shadow-2xl shadow-blue-900/20 backdrop-blur-xl',
                closeButton: 'text-slate-400 hover:text-white focus:outline-none'
            },
            didOpen: () => lucide.createIcons()
        });
    },

    /* --- MARKET APIs --- */
    async fetchDolarSimple() { try { const r = await fetch("https://dolarapi.com/v1/dolares/blue"); const d = await r.json(); document.getElementById("dolarRateTag").textContent = `@ $${d.venta}`; const i = this.data.records.filter(r => r.type === 'income').reduce((a, c) => a + c.amount, 0); const e = this.data.records.filter(r => r.type === 'expense').reduce((a, c) => a + c.amount, 0); if(d.venta > 0) document.getElementById("capitalUsd").textContent = `US$ ${((i - e) / d.venta).toLocaleString('en-US', {maximumFractionDigits: 0})}`; } catch(e) {} },
    
    async fetchFullMarket() {
        const ga=document.getElementById("marketGridArg"), gw=document.getElementById("marketGridWorld"), gc=document.getElementById("marketGridCrypto"), ic=document.getElementById("refreshIcon"); ic.classList.add("animate-spin"); this.rates={'USD':1,'EUR':0.92,'ARS_BLUE':0.001};
        try { const r=await fetch("https://dolarapi.com/v1/dolares"); const d=await r.json(); const f=d.filter(x=>x.casa==="oficial"||x.casa==="blue"); f.forEach(x=>{if(x.casa==='blue')this.rates['ARS_BLUE']=1/x.venta;if(x.casa==='oficial')this.rates['ARS_OFICIAL']=1/x.venta;}); ga.innerHTML=f.map(x=>`<div class="glass p-6 rounded-3xl relative overflow-hidden border border-emerald-500/30"><div class="flex items-center gap-3 mb-4"><div class="p-3 rounded-xl bg-emerald-500/20 text-emerald-400"><i data-lucide="dollar-sign" class="w-6 h-6"></i></div><h3 class="font-bold text-lg text-slate-200">D贸lar ${x.nombre}</h3></div><div class="grid grid-cols-2 gap-4"><div class="bg-black/20 p-3 rounded-xl"><p class="text-[10px] uppercase font-bold text-slate-500">Compra</p><p class="text-xl font-black text-white">$${x.compra}</p></div><div class="bg-black/20 p-3 rounded-xl border border-emerald-500/20"><p class="text-[10px] uppercase font-bold text-slate-500">Venta</p><p class="text-xl font-black text-emerald-400">$${x.venta}</p></div></div></div>`).join(''); } catch(e){}
        try {
            const r=await fetch("https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=8&page=1&sparkline=false"); const d=await r.json();
            d.forEach(c => this.rates[c.symbol.toUpperCase()] = c.current_price); this.fillCalcSelects(); 
            gc.innerHTML=d.map(c=> { const changeColor = c.price_change_percentage_24h >= 0 ? 'text-emerald-400' : 'text-rose-500'; return `<div class="glass p-5 rounded-3xl relative overflow-hidden hover:bg-white/5 transition-all border border-purple-500/20"><div class="flex items-center gap-3 mb-3"><img src="${c.image}" class="w-8 h-8 rounded-full shadow-lg ${c.price_change_percentage_24h > 5 ? 'crypto-pulse' : ''}"><div class="overflow-hidden"><h3 class="font-bold text-white truncate">${c.name}</h3><span class="text-xs font-bold text-slate-500 bg-black/30 px-2 py-0.5 rounded uppercase">${c.symbol}</span></div></div><div class="flex justify-between items-end"><div class="flex flex-col"><span class="text-[10px] font-bold text-slate-500">PRECIO USD</span><span class="text-xl font-mono font-bold text-white">$${c.current_price.toLocaleString()}</span></div><div class="flex flex-col items-end"><span class="text-[10px] font-bold text-slate-500">24H %</span><span class="text-sm font-bold ${changeColor}">${c.price_change_percentage_24h.toFixed(2)}%</span></div></div></div>`; }).join('');
        } catch(e) { gc.innerHTML = `<div class="col-span-full text-center text-slate-500 p-4">Crypto API Limit (Wait a min)</div>`; }
        try { const r=await fetch("https://api.frankfurter.app/latest?from=USD"); const d=await r.json(); Object.assign(this.rates,d.rates); const c=[{c:'EUR',n:'Euro',f:''},{c:'GBP',n:'Libra',f:''},{c:'JPY',n:'Yen',f:''},{c:'BRL',n:'Real',f:'ю'},{c:'MXN',n:'Peso MX',f:'拆'},{c:'CNY',n:'Yuan',f:''}]; gw.innerHTML=c.map(x=>{const v=d.rates[x.c]; if(!v)return''; return `<div class="glass p-4 rounded-2xl border border-blue-500/10 hover:border-blue-500/30"><div class="flex justify-between mb-2"><span class="text-2xl">${x.f}</span><span class="text-xs font-bold bg-black/30 px-2 py-1 rounded text-slate-400">${x.c}</span></div><p class="text-sm font-bold text-slate-300">${x.n}</p><p class="text-lg font-mono font-bold text-blue-400">${v.toFixed(2)}</p></div>`}).join(''); } catch(e){}
        setTimeout(()=>ic.classList.remove("animate-spin"),1000); lucide.createIcons();
    },
    fillCalcSelects() { 
        const opts = [{v:'USD',t:'吼 USD'},{v:'ARS_BLUE',t:' Blue'},{v:'EUR',t:' Euro'},{v:'BTC',t:' BTC'},{v:'ETH',t:' ETH'},{v:'USDT',t:' USDT'},{v:'BRL',t:'ю Real'}];
        const h=opts.map(o=>`<option value="${o.v}">${o.t}</option>`).join(''); 
        const s1=document.getElementById("calcFrom"), s2=document.getElementById("calcTo"); 
        if(s1.innerHTML.length < 50) { s1.innerHTML=h; s2.innerHTML=h; s2.value='ARS_BLUE'; } 
    },
    calcCurrency() { const a=parseFloat(document.getElementById("calcAmount").value)||0,f=document.getElementById("calcFrom").value,t=document.getElementById("calcTo").value; const r={...this.rates}; if(!r[f])r[f]=1;if(!r[t])r[t]=1; let u=f==='USD'?a:(f.includes('ARS')?a*r[f]:a/r[f]); let res=t==='USD'?u:(t.includes('ARS')?u/r[t]:u*r[t]); document.getElementById("calcResult").textContent=res.toLocaleString(undefined,{maximumFractionDigits:4}); },
    swapCalc() { const f=document.getElementById("calcFrom"), t=document.getElementById("calcTo"), tmp=f.value; f.value=t.value; t.value=tmp; this.calcCurrency(); },
    exportProExcel() { const wb = XLSX.utils.book_new(); const r=this.getFilteredRecords(); const i=r.filter(x=>x.type==='income').reduce((a,c)=>a+c.amount,0); const e=r.filter(x=>x.type==='expense').reduce((a,c)=>a+c.amount,0); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["REPORTE"],["Balance", i-e]]), "Resumen"); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["FECHA","DETALLE","MONTO"],...r.map(x=>[x.date,x.desc,x.amount])]), "Detalle"); XLSX.writeFile(wb, `FORJAX_${this.user}.xlsx`); },
};

app.init();
</script>
</body>
</html>
